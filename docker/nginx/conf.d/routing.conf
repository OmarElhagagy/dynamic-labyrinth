# =============================================================================
# Dynamic Labyrinth - Nginx Routing Configuration
# =============================================================================
# Cookie-based routing to honeytrap containers
# =============================================================================

# -----------------------------------------------------------------------------
# Main HTTP Server - Honeytrap Routing
# -----------------------------------------------------------------------------
server {
    listen 80;
    server_name _;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Nginx status (internal only)
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
    }

    # -------------------------------------------------------------------------
    # Dynamic Routing Based on Session Cookie
    # -------------------------------------------------------------------------
    # The $honeytrap_upstream variable is set by the map in honeytrap_upstream.map
    # If session has specific container assigned, route there
    # Otherwise, route to default level1_pool
    
    location / {
        # Set session cookie if not present
        if ($cookie_dlsess = "") {
            # Generate a new session ID (handled by honeytrap or app)
            add_header Set-Cookie "dlsess=dlsess_$request_id; Path=/; HttpOnly" always;
        }

        # Determine upstream based on cookie
        # $honeytrap_upstream is set by the map file
        set $backend $honeytrap_upstream;
        
        # If $honeytrap_upstream is empty or not set, use default
        if ($backend = "") {
            set $backend level1_pool;
        }

        # Proxy to the selected upstream
        proxy_pass http://$backend;
        
        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Session-ID $cookie_dlsess;
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
}

# -----------------------------------------------------------------------------
# Internal API Server
# -----------------------------------------------------------------------------
server {
    listen 8080;
    server_name _;

    # Only allow internal access
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    allow 127.0.0.1;
    deny all;

    # Orchestrator API
    location /api/orchestrator/ {
        rewrite ^/api/orchestrator/(.*) /$1 break;
        proxy_pass http://orchestrator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Cerebrum API
    location /api/cerebrum/ {
        rewrite ^/api/cerebrum/(.*) /$1 break;
        proxy_pass http://cerebrum;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Dashboard API
    location /api/dashboard/ {
        rewrite ^/api/dashboard/(.*) /$1 break;
        proxy_pass http://dashboard_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Health check
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}

# -----------------------------------------------------------------------------
# Dashboard Frontend Server
# -----------------------------------------------------------------------------
server {
    listen 3000;
    server_name _;

    # Dashboard frontend (static files or proxy to dev server)
    location / {
        proxy_pass http://dashboard-frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Dashboard API proxy
    location /api/ {
        proxy_pass http://dashboard_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
