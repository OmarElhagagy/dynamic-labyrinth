# =============================================================================
# Dynamic Labyrinth - Nginx Main Configuration
# =============================================================================
# Reverse proxy with cookie-based session routing to honeytrap containers
# =============================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    # -------------------------------------------------------------------------
    # Basic Settings
    # -------------------------------------------------------------------------
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging format with session info
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'session="$cookie_dlsess" upstream="$honeytrap_upstream"';

    log_format json escape=json '{'
        '"time": "$time_iso8601",'
        '"remote_addr": "$remote_addr",'
        '"request_method": "$request_method",'
        '"request_uri": "$request_uri",'
        '"status": $status,'
        '"body_bytes_sent": $body_bytes_sent,'
        '"request_time": $request_time,'
        '"http_referrer": "$http_referer",'
        '"http_user_agent": "$http_user_agent",'
        '"session_cookie": "$cookie_dlsess",'
        '"upstream": "$honeytrap_upstream"'
    '}';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    server_tokens off;

    # -------------------------------------------------------------------------
    # Include Session Map (generated by Orchestrator)
    # -------------------------------------------------------------------------
    include /etc/nginx/maps/honeytrap_upstream.map;

    # -------------------------------------------------------------------------
    # Include Upstream Definitions
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/upstreams.conf;

    # -------------------------------------------------------------------------
    # Include Server Configurations
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/routing.conf;
}

# =============================================================================
# Stream Configuration (for TCP/UDP proxying)
# =============================================================================
stream {
    # Log format for stream
    log_format stream '$remote_addr [$time_local] '
                      '$protocol $status $bytes_sent $bytes_received '
                      '$session_time';

    access_log /var/log/nginx/stream.log stream;

    # -------------------------------------------------------------------------
    # Include Stream Configurations
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/stream.conf;
}
